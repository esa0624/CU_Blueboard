<%#
  Post detail page: displays question, all answers, and anonymity/identity reveal features
%>

<div class="main-content-container" data-controller="post-show realtime" data-realtime-post-id-value="<%= @post.id %>">

  <%# --- Post title and author information (2-line compact layout) --- %>
  <h2 class="page-title"><%= @post.title %></h2>

  <%# Line 1: Author · Time · Expiration %>
  <div class="post-meta-line">
    <div class="post-meta-info">
      <span class="post-author">
        <strong><%= display_author(@post.user, context: @post) %></strong>
        <% if current_user == @post.user && !@post.show_real_identity? %>
          <span class="anonymous-badge">(anonymous)</span>
        <% end %>
      </span>
      <span class="meta-separator">·</span>
      <span class="post-time"><%= time_ago_in_words(@post.created_at) %> ago</span>
      <% if @post.expires_at.present? %>
        <span class="meta-separator">·</span>
        <span class="post-expiry">Expires <%= time_ago_in_words(@post.expires_at) %></span>
      <% end %>
    </div>
    <div class="post-meta-actions">
      <% if current_user == @post.user %>
        <% if !@post.show_real_identity? %>
          <%= button_to "Reveal Identity",
                        reveal_identity_post_path(@post),
                        method: :patch,
                        class: "btn-identity-toggle",
                        data: { turbo_confirm: "Reveal your real identity on this thread?" } %>
        <% else %>
          <%= button_to "Hide Identity",
                        hide_identity_post_path(@post),
                        method: :patch,
                        class: "btn-identity-toggle btn-hide",
                        data: { turbo_confirm: "Return to anonymous mode?" } %>
        <% end %>
      <% elsif @post.show_real_identity? %>
        <span class="identity-revealed-label">Identity revealed</span>
      <% end %>
    </div>
  </div>

  <%# Line 2: All metadata chips (Topic, Status, School, Course, Tags) %>
  <div class="post-chips-line">
    <span class="chip chip-topic"><%= @post.topic&.name %></span>
    <% status_class = case @post.status
       when 'solved' then 'chip-solved'
       when 'locked' then 'chip-locked'
       else 'chip-open'
       end %>
    <span class="chip <%= status_class %>">
      <%= @post.status.humanize %>
      <span class="status-help-icon" data-tooltip="Solved: Author accepted answer. Locked: Moderator closed thread.">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      </span>
    </span>
    <% if @post.school.present? %>
      <span class="chip chip-school"><%= @post.school %></span>
    <% end %>
    <% if @post.course_code.present? %>
      <span class="chip chip-course"><%= @post.course_code %></span>
    <% end %>
    <% @post.tags.each do |tag| %>
      <span class="chip chip-tag"><%= tag.name %></span>
    <% end %>
  </div>

  <% if @post.locked? %>
    <p class="identity-badge">Thread locked after accepting an answer.</p>
    <% if @post.user == current_user %>
      <%= button_to 'Reopen Thread',
                    unlock_post_path(@post),
                    method: :patch,
                    class: 'form-submit-button identity-button',
                    data: { turbo_confirm: 'Reopen this thread and allow new answers?' } %>
    <% end %>
  <% end %>

  <%# --- AI-Flagged Warning for Author/Moderator --- %>
  <% if @post.ai_flagged? && @post.visible? %>
    <% if @post.user == current_user || current_user&.can_moderate? %>
      <div class="ai-flagged-container">
        <div class="ai-flagged-warning-flex">
          <% if @post.ai_categories.present? %>
            <% flagged_categories = @post.ai_categories.select { |k, v| v }.keys %>
            <% if flagged_categories.any? %>
              <h4>Flagged for: <%= flagged_categories.map(&:titleize).join(', ') %></h4>
            <% else %>
              <h4>This post has been flagged for review</h4>
            <% end %>
          <% else %>
            <h4>This post has been flagged for review</h4>
          <% end %>
          <p>This post was automatically flagged by our content screening system.</p>
          <% if @post.user == current_user %>
            <p class="alert-note">Submit an appeal if you disagree. Otherwise, this decision is final.</p>
          <% end %>
        </div>
        <div class="actions-inline-box">
          <% if @post.user == current_user && !@post.appeal_requested? %>
            <h5>APPEAL</h5>
            <%= button_to "Request Review",
                          appeal_post_path(@post),
                          method: :post,
                          class: "btn-appeal-inline",
                          data: { turbo_confirm: "Submit an appeal for moderator review?" } %>
          <% elsif @post.appeal_requested? && @post.user == current_user %>
            <div class="appeal-pending-notice">
              <p>Appeal Pending</p>
              <small>Awaiting moderator review</small>
            </div>
          <% end %>
          <% if current_user&.can_moderate? %>
            <h5 class="moderator-actions-title">MODERATOR ACTIONS</h5>
            <div class="mod-actions-row">
              <%= button_to "Clear AI Flag",
                            clear_ai_flag_post_path(@post),
                            method: :patch,
                            class: "btn-approve-inline",
                            data: { turbo_confirm: "Clear AI flag and approve this post?" } %>
              <%= button_to "Redact Post",
                            redact_moderation_post_path(@post),
                            method: :patch,
                            class: "btn-redact-inline",
                            form: { data: { turbo_frame: "_top" } },
                            params: { reason: 'ai_flagged_content', state: 'redacted' },
                            data: { turbo_confirm: "Redact this AI-flagged post?" } %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# --- Post body with conditional rendering for redacted content --- %>
  <% if @post.redacted? || @post.partial? %>
    <% if @post.user == current_user %>
      <%# Author view: Warning + original content visible %>
      <div class="alert alert-warning">
        <h4>Content Flagged</h4>
        <p>Your post has been flagged for review.</p>
        <% if @post.redacted_reason.present? %>
          <p><strong>Reason:</strong> <%= @post.redacted_reason.humanize %></p>
        <% end %>
      </div>
      <div class="post-body">
        <%= @post.redacted_body || @post.body %>
      </div>
    <% elsif current_user&.can_moderate? %>
      <%# Moderator view: Full content + moderation panel %>
      <div class="moderator-panel alert alert-info">
        <h4>Moderator View</h4>
        <p><strong>Redaction State:</strong> <%= @post.redaction_state.humanize %></p>
        <% if @post.redacted_reason.present? %>
          <p><strong>Reason:</strong> <%= @post.redacted_reason.humanize %></p>
        <% end %>
        <% if @post.redacted_by.present? %>
          <p><strong>Redacted by:</strong> <%= @post.redacted_by.email %></p>
        <% end %>
        <div class="moderator-actions">
          <%= button_to "Restore Post", unredact_moderation_post_path(@post),
                        method: :patch,
                        class: "form-submit-button" %>
        </div>
      </div>
      <div class="post-body">
        <%= @post.redacted_body || @post.body %>
      </div>
    <% else %>
      <%# General users: Simple moderated message %>
      <div class="alert alert-danger redacted-content-notice">
        <h4>Content Moderated</h4>
        <p>This content has been moderated and is not visible.</p>
      </div>
    <% end %>
  <% else %>
    <%# Normal content display (with blur for AI-flagged author) %>
    <% if @post.ai_flagged? && @post.user == current_user %>
      <%# Author sees blurred content with "View My Content" button %>
      <div class="ai-flagged-content-wrapper">
        <div class="blurred-content blurred" data-post-show-target="blurredContent">
          <div class="post-body">
            <%= @post.body %>
          </div>
        </div>
        <div class="view-content-overlay" data-post-show-target="appealOverlay">
          <p class="view-content-message">Content hidden due to AI flagging</p>
          <button type="button"
                  class="btn-view-content"
                  data-action="click->post-show#showContent">
            View My Content
          </button>
        </div>
      </div>
    <% elsif @post.ai_flagged? && current_user&.can_moderate? %>
      <%# Moderator sees blurred content with "View the Post" button %>
      <div class="ai-flagged-content-wrapper">
        <div class="blurred-content blurred" data-post-show-target="blurredContent">
          <div class="post-body">
            <%= @post.body %>
          </div>
        </div>
        <div class="view-content-overlay" data-post-show-target="appealOverlay">
          <p class="view-content-message">AI-Flagged Content (Moderator View)</p>
          <button type="button"
                  class="btn-view-content"
                  data-action="click->post-show#showContent">
            View the Post
          </button>
        </div>
      </div>
    <% elsif @post.ai_flagged? %>
      <%# Regular users see only a notice - no content %>
      <div class="alert alert-warning">
        <p>This content has been flagged for review and is not available.</p>
      </div>
    <% else %>
      <%# Normal content %>
      <div class="post-body">
        <%= @post.body %>
      </div>
    <% end %>
  <% end %>

  <%# --- Post actions (two-row layout) --- %>
  <div class="post-actions-two-row">
    <%# Row 1: Votes + Bookmark %>
    <div class="post-actions-row-top">
      <% if user_signed_in? %>
        <% current_vote = @post.find_vote_by(current_user) %>
        <div class="vote-controls-inline">
          <%= button_to upvote_post_path(@post),
                        method: :post,
                        class: "btn-vote-inline btn-upvote #{'active' if current_vote&.upvote?}" do %>
            <span class="vote-arrow-inline">▲</span>
          <% end %>
          <span class="vote-score-inline"><%= @post.net_score %></span>
          <%= button_to downvote_post_path(@post),
                        method: :post,
                        class: "btn-vote-inline btn-downvote #{'active' if current_vote&.downvote?}" do %>
            <span class="vote-arrow-inline">▼</span>
          <% end %>
        </div>
        <% if @post.bookmarked_by?(current_user) %>
          <%= button_to unbookmark_post_path(@post), method: :delete, class: "btn-bookmark-inline bookmarked", data: { turbo: false } do %>
            <span class="bookmark-icon">★</span> Bookmarked
          <% end %>
        <% else %>
          <%= button_to bookmark_post_path(@post), method: :post, class: "btn-bookmark-inline", data: { turbo: false } do %>
            <span class="bookmark-icon">☆</span> Bookmark
          <% end %>
        <% end %>
      <% else %>
        <div class="vote-controls-inline guest">
          <span class="vote-score-inline"><%= @post.net_score %></span>
          <small>votes</small>
        </div>
      <% end %>
    </div>

    <%# Row 2: Author + Moderator Actions %>
    <div class="post-actions-row-bottom">
      <% if @post.user == current_user %>
        <%= link_to "Edit", edit_post_path(@post), class: "btn-action-sm btn-edit" %>
        <%= button_to "Delete", @post,
                    method: :delete,
                    class: "btn-action-sm btn-delete",
                    data: { turbo_confirm: "Are you sure you want to delete this post?" } %>
      <% end %>
      <% if current_user&.can_moderate? && !@post.redacted? && !@post.ai_flagged? %>
        <% if @post.reported? %>
          <%= button_to "Dismiss Flag",
                        dismiss_flag_post_path(@post),
                        method: :delete,
                        class: "btn-redact-elegant",
                        style: "background-color: #28a745; border-color: #28a745; margin-right: 10px;",
                        data: { turbo_confirm: "Dismiss user flag?" } %>
        <% end %>
        <%= button_to "Redact Post",
                      redact_moderation_post_path(@post),
                      method: :patch,
                      class: "btn-redact-elegant",
                      form: { data: { turbo_frame: "_top" } },
                      params: { reason: 'policy_violation', state: 'redacted' },
                      data: { turbo_confirm: "Redact this post for policy violations?" } %>
      <% end %>
      <% if user_signed_in? && @post.user != current_user %>
        <% if @post.reported_by?(current_user) %>
          <%= button_to "Remove My Report",
                        dismiss_flag_post_path(@post),
                        method: :delete,
                        class: "btn-action-sm btn-flag active",
                        data: { turbo_confirm: "Remove your report from this content?" } %>
        <% else %>
          <div class="report-dropdown">
            <button type="button" class="btn-action-sm btn-flag" onclick="toggleReportMenu(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px; vertical-align: -2px;"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>
              Report
            </button>
            <div class="report-menu" style="display: none;">
              <p class="report-menu-title">Why are you reporting?</p>
              <%= button_to report_post_path(@post), method: :post, params: {reason: 'inappropriate'}, class: "report-option" do %>
                <span class="report-option-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg></span> Inappropriate
              <% end %>
              <%= button_to report_post_path(@post), method: :post, params: {reason: 'harassment'}, class: "report-option" do %>
                <span class="report-option-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg></span> Harassment
              <% end %>
              <%= button_to report_post_path(@post), method: :post, params: {reason: 'spam'}, class: "report-option" do %>
                <span class="report-option-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></span> Spam
              <% end %>
              <%= button_to report_post_path(@post), method: :post, params: {reason: 'misinformation'}, class: "report-option" do %>
                <span class="report-option-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg></span> Misinformation
              <% end %>
              <%= button_to report_post_path(@post), method: :post, params: {reason: 'other'}, class: "report-option" do %>
                <span class="report-option-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></span> Other
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <hr class="section-divider">

  <%# --- Typing indicator --- %>
  <div class="typing-indicator" data-realtime-target="typingIndicator" style="display: none;"></div>

  <%# --- Answer form --- %>
  <div data-post-show-target="answerForm" data-realtime-target="answerForm">
    <% if @post.locked? %>
      <p class="identity-badge">This thread is locked. No new answers can be added.</p>
    <% else %>
      <h3 class="comments-title">Share Your Answer</h3>

      <%= form_with(model: [@post, @answer]) do |form| %>
        <% if @answer.errors.any? %>
          <div class="form-errors">
            <% @answer.errors.full_messages.each do |message| %>
              <p class="error-message"><%= message %></p>
            <% end %>
          </div>
        <% end %>
        <div class="form-field">
          <%= form.label :body, "Answer Content", class: "form-label" %>
          <%= form.text_area :body, class: "form-textarea", rows: 4, placeholder: "Share your guidance..." %>
        </div>
        <div class="form-actions">
          <%= form.submit "Submit Answer", class: "form-submit-button" %>
        </div>
      <% end %>
    <% end %>

    <hr class="section-divider">
  </div>

  <%# --- Answer list --- %>
  <h3 class="comments-title">Answers (<%= @answers.count %>)</h3>

  <div class="comments-list-container" id="answers" data-realtime-target="answers">
    <% @answers.each do |answer| %>
      <% next unless answer.persisted? %>
      <% accepted = (@post.accepted_answer_id == answer.id) %>
      <div class="comment-card <%= 'accepted-answer' if accepted %>" id="answer-<%= answer.id %>">
        <div class="answer-card-with-vote">
          <%# Left side: Voting section %>
          <div class="answer-vote-section">
            <% if user_signed_in? %>
              <% current_vote = answer.find_vote_by(current_user) %>
              <%= button_to upvote_post_answer_path(@post, answer),
                            method: :post,
                            class: "btn-vote-compact btn-upvote #{'active' if current_vote&.upvote?}",
                            data: { turbo_action: "replace" } do %>
                <span class="vote-arrow-compact">▲</span>
              <% end %>
              <div class="vote-score-compact"><%= answer.net_score %></div>
              <%= button_to downvote_post_answer_path(@post, answer),
                            method: :post,
                            class: "btn-vote-compact btn-downvote #{'active' if current_vote&.downvote?}",
                            data: { turbo_action: "replace" } do %>
                <span class="vote-arrow-compact">▼</span>
              <% end %>
            <% else %>
              <div class="vote-score-compact-guest"><%= answer.net_score %></div>
            <% end %>
          </div>

          <%# Right side: Answer content %>
          <div class="answer-content-section">
        <div class="comment-meta">
          <span class="comment-author">
            <strong><%= display_author(answer.user, context: answer) %></strong>
          </span>
          <span class="comment-time">
            <% if answer.created_at.present? %>
              <%= time_ago_in_words(answer.created_at) %> ago
            <% else %>
              just now
            <% end %>
          </span>
          <% if accepted %>
            <span class="identity-badge">Accepted answer</span>
          <% end %>
        </div>

        <%# Answer body with conditional rendering for redacted content %>
        <% if answer.redacted? || answer.partial? %>
          <% if answer.user == current_user %>
            <%# Author view: Warning + original content %>
            <div class="alert alert-warning">
              <p><strong>Your answer was flagged.</strong></p>
              <% if answer.redacted_reason.present? %>
                <p><strong>Reason:</strong> <%= answer.redacted_reason.humanize %></p>
              <% end %>
            </div>
            <div class="comment-body">
              <%= answer.redacted_body || answer.body %>
            </div>
          <% elsif current_user&.can_moderate? %>
            <%# Moderator view %>
            <div class="moderator-panel alert alert-info" style="font-size: 0.9em; padding: 0.5em;">
              <p><strong>Moderator:</strong> Redacted (<%= answer.redaction_state %>)</p>
              <%= button_to "Restore", unredact_moderation_answer_path(answer),
                            method: :patch,
                            class: "form-secondary-button",
                            style: "font-size: 0.85em; padding: 0.3em 0.6em;" %>
            </div>
            <div class="comment-body">
              <%= answer.redacted_body || answer.body %>
            </div>
          <% else %>
            <%# General users: Placeholder %>
            <div class="comment-body alert alert-info">
              <p>This answer is currently under review for content policy violations.</p>
            </div>
          <% end %>
        <% else %>
          <%# Normal content %>
          <div class="comment-body">
            <%= answer.body %>
          </div>
        <% end %>

        <div class="comment-actions">
          <% if @post.user == current_user && !@post.locked? %>
            <%= button_to "Accept Answer",
                          accept_post_answer_path(@post, answer),
                          method: :patch,
                          class: "comment-reveal-button",
                          data: { turbo_confirm: "Accept this answer and lock the thread?" } %>
          <% elsif accepted && @post.user == current_user %>
            <span class="identity-badge">This answer is locked in.</span>
          <% end %>

          <% if answer.user == current_user %>
            <%= link_to "Edit Answer", edit_post_answer_path(@post, answer),
                        class: "comment-reveal-button" %>
            <%= button_to "Delete Answer", [@post, answer],
                        method: :delete,
                        class: "comment-delete-link",
                        data: { turbo_confirm: "Are you sure?" } %>
            <% if answer.show_real_identity? %>
              <span class="identity-badge">Answerer revealed their identity.</span>
            <% else %>
              <%= button_to "Reveal My Identity",
                            reveal_identity_post_answer_path(@post, answer),
                            method: :patch,
                            class: "comment-reveal-button",
                            data: { turbo_confirm: "Reveal your identity on this answer?" } %>
            <% end %>
          <% elsif answer.show_real_identity? %>
            <span class="identity-badge">Answerer revealed their identity.</span>
          <% end %>

          <%# Moderator actions for answers %>
          <% if current_user&.can_moderate? && !answer.redacted? %>
            <%= button_to "Redact Answer",
                          redact_moderation_answer_path(answer),
                          method: :patch,
                          class: "btn-redact-elegant",
                          params: { reason: 'policy_violation', state: 'redacted' },
                          data: { turbo_confirm: "Redact this answer for policy violations?" } %>
          <% end %>
        </div>
          </div><%# Close answer-content-section %>
        </div><%# Close answer-card-with-vote %>

        <% if answer.answer_comments.any? %>
          <div class="answer-comments">
            <% answer.answer_comments.order(created_at: :asc).each do |comment| %>
              <div class="answer-comment" id="comment-<%= comment.id %>">
                <div class="answer-comment-header">
                  <span class="comment-author"><%= display_author(comment.user, context: comment) %></span>
                  <span class="comment-time"><%= time_ago_in_words(comment.created_at) %> ago</span>
                  <%# Micro vote buttons for comments %>
                  <% if user_signed_in? %>
                    <% comment_vote = comment.find_vote_by(current_user) %>
                    <div class="vote-controls-micro">
                      <%= button_to upvote_post_answer_comment_path(@post, answer, comment),
                                    method: :post,
                                    class: "btn-vote-micro btn-upvote #{'active' if comment_vote&.upvote?}",
                                    data: { turbo_action: "replace" } do %>
                        <span>▲</span>
                      <% end %>
                      <span class="vote-score-micro"><%= comment.net_score %></span>
                      <%= button_to downvote_post_answer_comment_path(@post, answer, comment),
                                    method: :post,
                                    class: "btn-vote-micro btn-downvote #{'active' if comment_vote&.downvote?}",
                                    data: { turbo_action: "replace" } do %>
                        <span>▼</span>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="vote-score-micro-guest"><%= comment.net_score %></span>
                  <% end %>
                </div>
                <p class="answer-comment-body"><%= comment.body %></p>
                <% if comment.user == current_user %>
                  <div class="comment-actions">
                    <%= button_to 'Delete', post_answer_comment_path(@post, answer, comment),
                                  method: :delete,
                                  class: 'comment-delete-link',
                                  data: { turbo_confirm: 'Delete this comment?' } %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>

        <div class="answer-comment-toggle">
          <%= link_to "Reply", "#",
                      class: "btn-comment-toggle",
                      data: { action: "click->post-show#toggleCommentForm", answer_id: answer.id } %>
        </div>

        <div class="answer-comment-form" id="comment-form-<%= answer.id %>" style="display: none;">
          <%= form_with(model: AnswerComment.new, url: post_answer_comments_path(@post, answer)) do |form| %>
            <div class="form-field">
              <%= form.label :body, 'Add a comment', class: 'form-label' %>
              <%= form.text_area :body, class: 'form-textarea', rows: 2, placeholder: 'Add a clarifying comment...' %>
            </div>
            <div class="form-actions">
              <%= form.submit 'Comment', class: 'form-secondary-button' %>
            </div>
          <% end %>
        </div>

        <% if answer.answer_revisions.any? %>
          <div class="revision-history answer-revisions">
            <details>
              <summary>Answer edit history (<%= answer.answer_revisions.count %>)</summary>
              <ul>
                <% answer.answer_revisions.order(created_at: :desc).each do |revision| %>
                  <li>
                    <div class="revision-meta">
                      <span class="revision-author"><%= display_author(revision.user, context: answer) %></span>
                      <span class="revision-time"><%= time_ago_in_words(revision.created_at) %> ago</span>
                    </div>
                    <p><%= simple_format(revision.body) %></p>
                  </li>
                <% end %>
              </ul>
            </details>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if @post.post_revisions.any? %>
    <hr class="section-divider">
    <%= render 'revision_history', post: @post %>
  <% end %>
</div>

<style>
  /* 2-Line Compact Layout */
  .post-meta-line {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75em;
    flex-wrap: wrap;
    gap: 0.5em;
  }

  .post-meta-info {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.35em;
    font-size: 0.9em;
    color: #6c757d;
  }

  .post-author {
    color: #495057;
  }

  .post-author strong {
    color: #212529;
  }

  .anonymous-badge {
    color: #6c757d;
    font-size: 0.85em;
    font-weight: normal;
    margin-left: 0.25em;
  }

  .meta-separator {
    color: #adb5bd;
    font-weight: 300;
  }

  .post-time {
    color: #6c757d;
  }

  .post-expiry {
    color: #856404;
    font-weight: 500;
  }

  .post-meta-actions {
    display: flex;
    align-items: center;
    gap: 0.5em;
  }

  .btn-identity-toggle {
    padding: 0.3em 0.75em;
    background-color: #17a2b8;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-identity-toggle:hover {
    background-color: #138496;
  }

  .btn-identity-toggle.btn-hide {
    background-color: #6c757d;
  }

  .btn-identity-toggle.btn-hide:hover {
    background-color: #5a6268;
  }

  .identity-revealed-label {
    font-size: 0.8em;
    color: #0c5460;
    background-color: #d1ecf1;
    padding: 0.25em 0.5em;
    border-radius: 4px;
  }

  /* Chips Line (All metadata in one row) */
  .post-chips-line {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5em;
    margin-bottom: 1em;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    padding: 0.2em 0.6em;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 500;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    color: #495057;
  }

  .chip-topic {
    background-color: #e3f2fd;
    border-color: #90caf9;
    color: #1565c0;
  }

  .chip-open {
    background-color: #e8f5e9;
    border-color: #a5d6a7;
    color: #2e7d32;
  }

  .chip-solved {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
  }

  .chip-locked {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }

  .chip-school {
    background-color: #fff3e0;
    border-color: #ffcc80;
    color: #e65100;
  }

  .chip-course {
    background-color: #f3e5f5;
    border-color: #ce93d8;
    color: #7b1fa2;
  }

  .chip-tag {
    background-color: #e8eaf6;
    border-color: #9fa8da;
    color: #3949ab;
  }

  .chip .status-help-icon {
    margin-left: 0.3em;
    display: inline-flex;
    align-items: center;
    cursor: help;
    opacity: 0.7;
  }

  .chip .status-help-icon:hover {
    opacity: 1;
  }

  /* AI-Flagged Container (Banner + Actions side by side) */
  .ai-flagged-container {
    display: flex;
    gap: 1.5em;
    background-color: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 8px;
    padding: 1.25em;
    margin: 1.5em 0;
    align-items: flex-start;
  }

  .ai-flagged-warning-flex {
    flex: 1;
  }

  .ai-flagged-warning-flex h4 {
    color: #856404;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-size: 1.05em;
    font-weight: 600;
  }

  .ai-flagged-warning-flex p {
    color: #856404;
    margin-bottom: 0.5em;
    font-size: 0.95em;
  }

  .ai-flagged-warning-flex .alert-note {
    font-size: 0.85em;
    font-style: italic;
    margin-bottom: 0;
    color: #6c757d;
  }

  .actions-inline-box {
    background-color: #fff;
    border: 2px dashed #ffc107;
    border-radius: 8px;
    padding: 1em;
    min-width: 200px;
  }

  .actions-inline-box h5 {
    color: #856404;
    font-size: 0.75em;
    margin-top: 0;
    margin-bottom: 0.75em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .moderator-actions-title {
    margin-top: 1em;
    padding-top: 0.75em;
    border-top: 1px solid #ffc107;
  }

  .btn-appeal-inline {
    padding: 0.6em 1.25em;
    background-color: #007bff;
    color: white;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    width: 100%;
  }

  .btn-appeal-inline:hover {
    background-color: #0056b3;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
  }

  .appeal-pending-notice {
    text-align: center;
    padding: 0.75em;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 6px;
  }

  .appeal-pending-notice p {
    margin: 0;
    color: #0c5460;
    font-weight: 600;
    font-size: 0.9em;
  }

  .appeal-pending-notice small {
    color: #0c5460;
    font-size: 0.8em;
  }

  .btn-redact-inline {
    padding: 0.6em 1.25em;
    background-color: #dc3545;
    color: white;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    width: 100%;
  }

  .btn-redact-inline:hover {
    background-color: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
  }

  /* Blurred Content for AI-Flagged Author */
  .ai-flagged-content-wrapper {
    position: relative;
    margin: 1.5em 0;
    min-height: 200px;
  }

  .blurred-content {
    position: relative;
  }

  .blurred-content.blurred {
    filter: blur(8px);
    pointer-events: none;
    user-select: none;
  }

  .view-content-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    background-color: rgba(255, 255, 255, 0.98);
    padding: 2.5em 3em;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 10;
    border: 3px solid #ffc107;
  }

  .view-content-message {
    font-size: 1.15em;
    color: #495057;
    margin-bottom: 1.5em;
    font-weight: 600;
  }

  .btn-view-content {
    padding: 0.85em 2.5em;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.05em;
    cursor: pointer;
    transition: all 0.25s;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
  }

  .btn-view-content:hover {
    background-color: #0056b3;
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0, 123, 255, 0.5);
  }

  /* Redacted Content Notice */
  .redacted-content-notice {
    background-color: #f8d7da;
    border: 2px solid #dc3545;
    border-radius: 8px;
    padding: 1.5em;
    margin: 1.5em 0;
    text-align: center;
  }

  .redacted-content-notice h4 {
    color: #721c24;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-size: 1.1em;
    font-weight: 600;
  }

  .redacted-content-notice h4::before {
    content: "■ ";
    margin-right: 0.5em;
    font-weight: bold;
  }

  .redacted-content-notice p {
    color: #721c24;
    margin-bottom: 0;
    font-size: 0.95em;
  }

  /* Post Actions Container */
  .post-actions-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 2em 0;
    gap: 2em;
    flex-wrap: wrap;
    position: relative;
  }

  /* Status Badges */
  .status-solved {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .status-locked {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .status-open {
    background-color: #e2e3e5;
    color: #383d41;
    border: 1px solid #d6d8db;
  }

  /* Flag/Report Button (Red) */
  .btn-flag {
    background-color: transparent;
    color: #dc3545;
    border: 1px solid #dc3545;
  }

  .btn-flag:hover {
    background-color: #dc3545;
    color: white;
  }

  .btn-flag.active {
    background-color: #dc3545;
    color: white;
  }

  /* Report Dropdown */
  .report-dropdown {
    position: relative;
    display: inline-block;
  }

  .report-menu {
    position: absolute;
    bottom: 100%;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 200px;
    padding: 12px 0;
    margin-bottom: 8px;
    z-index: 100;
  }

  .report-menu-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #495057;
    padding: 0 12px 8px;
    margin: 0;
    border-bottom: 1px solid #e9ecef;
  }

  .report-option {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 10px 12px;
    background: none;
    border: none;
    color: #495057;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.15s;
    text-align: left;
  }

  .report-option:hover {
    background-color: #f8f9fa;
    color: #212529;
  }

  .report-option-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
    width: 16px;
    height: 16px;
  }

  .report-option-icon svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    color: #6c757d;
  }

  .report-option:hover .report-option-icon svg {
    color: #dc3545;
  }

  /* Vote Section - Center Large */
  .vote-section-center {
    flex: 0 0 auto;
    order: 0;
  }

  .vote-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75em;
  }

  .btn-vote-large {
    width: 64px;
    height: 64px;
    border: 3px solid #dee2e6;
    background-color: #fff;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }

  .btn-vote-large:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .btn-upvote:hover {
    border-color: #28a745;
    background-color: #d4edda;
  }

  .btn-downvote:hover {
    border-color: #dc3545;
    background-color: #f8d7da;
  }

  .btn-upvote.active {
    border-color: #28a745;
    background-color: #d4edda;
  }

  .btn-downvote.active {
    border-color: #dc3545;
    background-color: #f8d7da;
  }

  .vote-arrow {
    font-size: 2em;
    font-weight: bold;
    color: #6c757d;
  }

  .btn-upvote.active .vote-arrow {
    color: #28a745;
  }

  .btn-downvote.active .vote-arrow {
    color: #dc3545;
  }

  .btn-upvote:hover .vote-arrow {
    color: #28a745;
  }

  .btn-downvote:hover .vote-arrow {
    color: #dc3545;
  }

  .vote-score {
    font-size: 1.5em;
    font-weight: 700;
    color: #212529;
    padding: 0.25em 0;
    min-width: 50px;
    text-align: center;
  }

  .vote-controls-guest {
    text-align: center;
  }

  .vote-score-guest {
    font-size: 1.5em;
    font-weight: 700;
    color: #6c757d;
  }

  .vote-controls-guest small {
    color: #adb5bd;
    font-size: 0.9em;
  }

  /* Author Actions Group */
  .author-actions-group {
    display: flex;
    gap: 0.75em;
    flex-wrap: wrap;
    order: 1;
    position: absolute;
    right: 0;
  }

  .btn-action {
    padding: 0.6em 1.5em;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.95em;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
  }

  .btn-action.btn-edit {
    background-color: #007bff;
    color: white;
  }

  .btn-action.btn-edit:hover {
    background-color: #0056b3;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
  }

  .btn-action.btn-delete {
    background-color: #dc3545;
    color: white;
  }

  .btn-action.btn-delete:hover {
    background-color: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
  }

  /* Answers Toggle */
  .answers-toggle {
    text-align: center;
    margin: 1.5em 0;
  }

  .btn-answers-toggle {
    padding: 0.75em 2em;
    background-color: #6c757d;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    display: inline-block;
    transition: all 0.2s;
  }

  .btn-answers-toggle:hover {
    background-color: #5a6268;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
  }

  /* Moderator Panel Bottom */
  .moderator-panel-actions-bottom {
    background-color: #fff3cd;
    border: 2px dashed #ffc107;
    border-radius: 8px;
    padding: 1.25em;
    margin-top: 1.5em;
  }

  .moderator-section-title {
    color: #856404;
    font-size: 0.85em;
    margin-top: 0;
    margin-bottom: 0.75em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .btn-redact {
    padding: 0.6em 1.5em;
    background-color: #dc3545;
    color: white;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .btn-redact:hover {
    background-color: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
  }

  /* Two-Row Post Actions Layout */
  .post-actions-two-row {
    margin: 1.5em 0;
    display: flex;
    flex-direction: column;
    gap: 0.75em;
  }

  .post-actions-row-top {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5em;
    padding: 0.75em 0;
    border-bottom: 1px solid #e9ecef;
  }

  .post-actions-row-bottom {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75em;
    padding: 0.5em 0;
    flex-wrap: wrap;
  }

  /* Inline Vote Controls */
  .vote-controls-inline {
    display: flex;
    align-items: center;
    gap: 0.5em;
  }

  .vote-controls-inline.guest {
    color: #6c757d;
    font-size: 0.95em;
  }

  .vote-controls-inline.guest small {
    margin-left: 0.25em;
    color: #adb5bd;
  }

  .btn-vote-inline {
    width: 36px;
    height: 36px;
    border: 2px solid #dee2e6;
    background-color: #fff;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .btn-vote-inline:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .btn-vote-inline.btn-upvote:hover {
    border-color: #28a745;
    background-color: #d4edda;
  }

  .btn-vote-inline.btn-downvote:hover {
    border-color: #dc3545;
    background-color: #f8d7da;
  }

  .btn-vote-inline.btn-upvote.active {
    border-color: #28a745;
    background-color: #d4edda;
  }

  .btn-vote-inline.btn-downvote.active {
    border-color: #dc3545;
    background-color: #f8d7da;
  }

  .vote-arrow-inline {
    font-size: 1.1em;
    font-weight: bold;
    color: #6c757d;
    line-height: 1;
  }

  .btn-vote-inline.btn-upvote.active .vote-arrow-inline,
  .btn-vote-inline.btn-upvote:hover .vote-arrow-inline {
    color: #28a745;
  }

  .btn-vote-inline.btn-downvote.active .vote-arrow-inline,
  .btn-vote-inline.btn-downvote:hover .vote-arrow-inline {
    color: #dc3545;
  }

  .vote-score-inline {
    font-size: 1.1em;
    font-weight: 700;
    color: #212529;
    min-width: 32px;
    text-align: center;
  }

  /* Inline Bookmark Button */
  .btn-bookmark-inline {
    display: flex;
    align-items: center;
    gap: 0.4em;
    padding: 0.5em 1em;
    border: 2px solid #dee2e6;
    background-color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s ease;
  }

  .btn-bookmark-inline:hover {
    border-color: #ffc107;
    background-color: #fff3cd;
    color: #856404;
  }

  .btn-bookmark-inline .bookmark-icon {
    font-size: 1.1em;
  }

  .btn-bookmark-inline.bookmarked {
    border-color: #ffc107;
    background-color: #fff3cd;
    color: #856404;
  }

  .btn-bookmark-inline.bookmarked .bookmark-icon {
    color: #ffc107;
  }

  .btn-bookmark-inline.bookmarked:hover {
    background-color: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
  }

  /* Small Action Buttons */
  .btn-action-sm {
    padding: 0.4em 1em;
    border-radius: 5px;
    font-weight: 500;
    font-size: 0.85em;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
  }

  .btn-action-sm.btn-edit {
    background-color: #007bff;
    color: white;
  }

  .btn-action-sm.btn-edit:hover {
    background-color: #0056b3;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
  }

  .btn-action-sm.btn-delete {
    background-color: #dc3545;
    color: white;
  }

  .btn-action-sm.btn-delete:hover {
    background-color: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
  }

  .btn-action-sm.btn-mod {
    background-color: #6c757d;
    color: white;
  }

  .btn-action-sm.btn-mod:hover {
    background-color: #5a6268;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(108, 117, 125, 0.3);
  }

  /* Moderator Actions Row */
  .mod-actions-row {
    display: flex;
    gap: 0.5em;
    flex-wrap: wrap;
  }

  /* Approve/Clear AI Flag Button */
  .btn-approve-inline {
    padding: 0.6em 1.25em;
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.25);
  }

  .btn-approve-inline:hover {
    background: linear-gradient(135deg, #218838 0%, #19692c 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
  }

  /* Realtime Features */
  .typing-indicator {
    padding: 0.75em 1em;
    background-color: #e9ecef;
    border-radius: 8px;
    font-size: 0.9em;
    color: #495057;
    margin-bottom: 1em;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .answer-highlight {
    animation: highlight-flash 3s ease-out;
  }

  @keyframes highlight-flash {
    0% { background-color: #d4edda; }
    100% { background-color: transparent; }
  }

  .realtime-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #28a745;
    color: white;
    padding: 1em 1.5em;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    animation: slide-in 0.3s ease-out;
  }

  @keyframes slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .realtime-notification.fade-out {
    animation: fade-out 0.5s ease-out forwards;
  }

  @keyframes fade-out {
    to {
      opacity: 0;
      transform: translateY(10px);
    }
  }
</style>

<script>
  function toggleReportMenu(button) {
    const dropdown = button.closest('.report-dropdown');
    const menu = dropdown.querySelector('.report-menu');
    const isVisible = menu.style.display !== 'none';

    // Close all other open menus
    document.querySelectorAll('.report-menu').forEach(m => {
      m.style.display = 'none';
    });

    // Toggle this menu
    menu.style.display = isVisible ? 'none' : 'block';
  }

  // Close menu when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.report-dropdown')) {
      document.querySelectorAll('.report-menu').forEach(menu => {
        menu.style.display = 'none';
      });
    }
  });
</script>

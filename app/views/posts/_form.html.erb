<%= form_with(model: post) do |form| %>
  <% submit_label = post.persisted? ? 'Save Changes' : 'Submit Post' %>

  <% if post.errors.any? %>
    <div class="form-errors">
      <% post.errors.full_messages.each do |message| %>
        <p class="error-message"><%= message %></p>
      <% end %>
    </div>
  <% end %>

  <% if defined?(@duplicate_posts) && @duplicate_posts.present? %>
    <%= hidden_field_tag :confirm_duplicate, true %>
    <div class="duplicate-warning">
      <h3>Possible similar threads</h3>
      <ul>
        <% @duplicate_posts.each do |duplicate| %>
          <li>
            <%= link_to duplicate.title, post_path(duplicate), class: 'duplicate-link' %>
            <span class="meta-time">&middot; <%= time_ago_in_words(duplicate.created_at) %> ago</span>
          </li>
        <% end %>
      </ul>
      <p class="form-hint">If one of these answers your question, consider adding to that thread instead of creating a duplicate.</p>
    </div>
  <% end %>

  <% expiry_options = [
    ['No expiry (default)', ''],
    ['7 days', '7'],
    ['14 days', '14'],
    ['30 days', '30']
  ] %>
  <% preselected_expiry = if post.expires_at.present?
      remaining_days = ((post.expires_at.to_date - Date.current)).to_i
      %w[7 14 30].include?(remaining_days.to_s) ? remaining_days.to_s : ''
    else
      ''
    end %>

  <div class="form-field">
    <%= form.label :title, class: "form-label" do %>
      Title <span class="required-indicator">*</span>
    <% end %>
    <%= form.text_field :title, class: "form-input", placeholder: "Enter your question title..." %>
  </div>

  <div class="form-field">
    <%= form.label :body, class: "form-label" do %>
      Content <span class="required-indicator">*</span>
    <% end %>
    <%= form.text_area :body, class: "form-textarea", placeholder: "Add your details here..." %>
  </div>

  <div class="form-field">
    <%= form.label :topic_id, class: "form-label" do %>
      Topic <span class="required-indicator">*</span>
    <% end %>
    <%= form.collection_select :topic_id, @topics, :id, :name, { prompt: "Select a topic" }, class: "form-input" %>
  </div>

  <div class="form-field" data-controller="tag-picker" data-tag-picker-max-value="<%= Post::TAG_LIMIT %>">
    <%= form.label :tag_ids, class: "form-label" do %>
      Tags <span class="required-indicator">*</span>
    <% end %>
    <div class="tag-picker">
      <%= hidden_field_tag 'post[tag_ids][]', '' %>
      <% if @tags.any? %>
        <% @tags.each do |tag| %>
          <% checkbox_id = "post_tag_#{tag.id}" %>
          <label class="tag-chip" for="<%= checkbox_id %>">
            <%= check_box_tag 'post[tag_ids][]', tag.id, post.tag_ids.include?(tag.id), id: checkbox_id, data: { tag_picker_target: 'input', action: 'tag-picker#toggle' } %>
            <span><%= tag.name %></span>
          </label>
        <% end %>
      <% else %>
        <div class="alert alert-danger">
          <strong>System Error:</strong> No tags found. Please run <code>rails db:seed</code> to populate tags.
        </div>
      <% end %>
    </div>
    <small class="form-hint">Choose between <%= Post::MIN_TAGS %> and <%= Post::TAG_LIMIT %> tags.</small>
  </div>

  <div class="form-field">
    <%= form.label :school, class: "form-label" do %>
      School <span class="required-indicator">*</span>
    <% end %>
    <%= form.select :school,
          options_for_select(Post::SCHOOLS, post.school),
          { include_blank: 'Select a school' },
          class: 'form-input' %>
  </div>

  <div class="form-field">
    <%= form.label :course_code, "Course", class: "form-label" %>
    <%= form.text_field :course_code, class: "form-input", placeholder: "e.g., COMS W4152" %>
  </div>

  <div class="form-field">
    <%= form.label :expires_at, "Make this post disappear after:", class: "form-label" %>
    <%= form.select :expires_at,
          options_for_select(expiry_options, selected: preselected_expiry),
          {},
          class: 'form-input' %>
    <small class="form-hint">Optional: choose an expiration window between 7 and 30 days.</small>
  </div>

  <div class="form-field read-only-field">
    <label class="form-label">Thread status</label>
    <span class="status-pill"><%= (post.status || 'open').humanize %></span>
  </div>

  <div class="form-actions">

    <%= form.submit submit_label, class: "form-submit-button" %>
    <%= link_to "Cancel", posts_path, 
            class: "form-cancel-button",
            onclick: "return confirm('Are you sure you want to cancel? Any unsaved changes will be lost.');" %>
  </div>
  
<% end %>
